<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Baca Ebook | Libra</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/profil.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.min.js"></script>
    
    <script>
        // Konfigurasi Firebase (HARUS SAMA DENGAN FILE LAIN)
        const firebaseConfig = {
            apiKey: "AIzaSyCdVYKc6waij3pmxI9dLDSBIgbYiFIRr3A",
            authDomain: "libra-library-area.firebaseapp.com",
            databaseURL: "https://libra-library-area-default-rtdb.asia-southeast1.firebasedatabase.app", 
            projectId: "libra-library-area",
            storageBucket: "libra-library-area.firebasestorage.app",
            messagingSenderId: "455509444693",
            appId: "1:455509444693:web:883766ec8a49032f0b2cdc",
        };
        
        firebase.initializeApp(firebaseConfig);
        const dbRef = firebase.database().ref(); 
        console.log("Firebase Realtime Database berhasil diinisialisasi.");
        
        // Atur workerSrc untuk PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.worker.min.js';
        
        // Tailwind Config (untuk memastikan utilitas berfungsi)
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4f46e5', 
                    },
                }
            }
        }
    </script>
    <script src="js/script.js"></script>
    <style>
        /* Gaya dasar untuk reader */
        #ebook-reader-container {
            width: 100%;
            max-width: 900px;
            margin: 20px auto;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            background-color: #f0f0f0; 
        }
        
        /* Style untuk canvas agar responsif dan menyesuaikan lebar container */
        #pdf-canvas {
            width: 100%;
            height: auto;
            border: none;
            display: block; 
            background-color: #fff; 
        }
        
        /* Container untuk canvas agar bisa di-scroll secara vertikal */
        #pdf-viewer-wrapper {
            overflow-y: auto;
            max-height: 85vh; /* Sedikit lebih besar agar pandangan lebih luas */
            width: 100%;
        }
        
        /* Style untuk tombol navigasi */
        .nav-btn-size {
            /* Compact di mobile, medium di desktop */
            padding: 8px 10px; 
            font-size: 0.875rem; /* text-sm */
        }
        @media (min-width: 640px) { /* sm */
            .nav-btn-size {
                padding: 10px 18px;
                font-size: 1rem; /* text-base */
            }
        }
    </style>
</head>
<body id="baca-buku-page" onload="renderEbookReader()">
    <header class="header">
        <div id="hamburger-menu" class="hamburger order-1"><i class="fas fa-bars"></i></div>
        <div class="logo order-2"><a href="index.html">Libra</a></div>
        <div class="header-right-menu order-3">
            <div id="profile-icon" class="profile-icon">
                <img id="header-profile-img" src="img/default_user.png" alt="Profil">
                <i class="fas fa-user-circle default-icon"></i> 
            </div>
        </div>
        <nav class="nav-menu">
            <a href="index.html">Beranda</a>
            <a href="pinjam.html">Pinjam Buku</a>
            <a href="ebook.html">Ebook</a>
            <a href="bookmark.html">BOOKMARK</a>
            <a href="saran.html">Saran & Kritik</a>
        </nav>
    </header>

    <main class="container py-8">
        <h1 id="ebook-title" class="text-xl sm:text-3xl font-bold text-center mb-4">Memuat Ebook...</h1>

        <div id="ebook-reader-container">
            <div id="pdf-viewer-wrapper">
                <canvas id="pdf-canvas"></canvas> 
            </div>
        </div>
        
        <div id="navigation-bar" class="flex justify-between items-center max-w-xl mx-auto px-4 w-full mt-4 mb-4">
            
            <button id="btn-prev-page" class="bg-gray-500 hover:bg-gray-600 rounded disabled:opacity-50 text-white nav-btn-size" disabled>
                <i class="fas fa-arrow-left"></i> <span class="hidden sm:inline">Sebelumnya</span>
            </button>
            
            <div class="flex items-center space-x-1 sm:space-x-2">
                <span class="font-semibold text-sm hidden md:inline">Halaman:</span>
                <input type="number" id="page-num-input" value="1" min="1" class="w-12 sm:w-16 p-1 sm:p-2 border rounded text-center text-sm font-semibold" />
                <span id="page-count-info" class="font-semibold text-sm">/ ?</span>
            </div>

            <button id="btn-next-page" class="bg-primary hover:bg-indigo-700 rounded text-white nav-btn-size">
                <span class="hidden sm:inline">Selanjutnya</span> <i class="fas fa-arrow-right"></i>
            </button>
        </div>
        <p id="last-read-info" class="text-center text-gray-500 mt-4 text-sm">Note: Progress akan tersimpan otomatis saat pindah halaman.</p>
    </main>

    <div id="profile-sidebar" class="sidebar">
        <div class="sidebar-header">
            <button id="close-sidebar" class="close-btn">&times;</button>
        </div>
        <div class="profile-info text-center p-4">
            <img id="sidebar-profile-img" src="img/default_user.png" alt="Foto Profil" class="w-24 h-24 rounded-full mx-auto border-4 border-white shadow-lg">
            <h3 id="sidebar-username" class="mt-3 text-xl font-semibold">Pengunjung</h3>
        </div>
        <nav class="sidebar-nav pt-4">
            <a href="history.html" class="sidebar-link login-feature">
                <i class="fas fa-history mr-3"></i> Riwayat Bacaan
            </a>
            <a href="#" class="sidebar-link login-feature" id="link-edit-profile-photo">
                <i class="fas fa-camera mr-3"></i> Edit Foto Profil
            </a>
            <a href="reset_password.html" class="sidebar-link login-feature" id="link-reset-password">
                <i class="fas fa-key mr-3"></i> Reset Password
            </a>
            <hr class="my-4 border-gray-200 login-feature">
            <a href="login.html" class="sidebar-link logout-link" id="sidebar-auth-link">
                <i class="fas fa-sign-in-alt mr-3" id="auth-icon"></i> <span id="auth-text">Login/Daftar</span>
            </a>
        </nav>
    </div>
    <div id="sidebar-overlay" class="sidebar-overlay"></div>

    <div id="edit-photo-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-[1000]">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm mx-4">
            <h3 class="text-xl font-bold mb-4">Ubah Foto Profil</h3>
            <form id="edit-photo-form">
                <input type="file" id="modal-foto-upload" accept="image/*" required class="w-full mb-4 p-2 border rounded">
                <div class="flex justify-end space-x-3">
                    <button type="button" id="close-modal" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Batal</button>
                    <button type="submit" class="px-4 py-2 bg-primary text-white rounded hover:bg-indigo-700">Simpan Foto</button>
                </div>
            </form>
        </div>
    </div>
    <script src="js/profil.js"></script>
    
    <script>
        let pdfDoc = null;
        let pageNum = 1;
        let pageRendering = false;
        let pageNumPending = null;
        const canvas = document.getElementById('pdf-canvas');
        const ctx = canvas.getContext('2d');
        const pageNumInput = document.getElementById('page-num-input');
        const pageCountInfo = document.getElementById('page-count-info');

        /**
         * Mengambil data Ebook dari Firebase berdasarkan ID di URL
         */
        async function getEbookDataFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const ebookId = urlParams.get('id');
            if (!ebookId) {
                document.getElementById('ebook-title').textContent = "Error: ID Ebook tidak ditemukan.";
                return null;
            }
            
            try {
                // Asumsi getAllData() ada di script.js
                const data = typeof getAllData === 'function' ? await getAllData() : { books: [] };
                const ebook = data.books.find(b => b.id === ebookId && b.isEbook);
                
                if (!ebook || !ebook.fileUrl) {
                    document.getElementById('ebook-title').textContent = "Error: Ebook tidak ditemukan atau link file hilang.";
                    return null;
                }
                document.getElementById('ebook-title').textContent = ebook.title || 'Ebook';
                document.title = `${ebook.title || 'Ebook'} | Libra`;
                return ebook;
            } catch (error) {
                console.error("Error fetching ebook data:", error);
                document.getElementById('ebook-title').textContent = "Error: Gagal memuat data Ebook.";
                return null;
            }
        }
        
        /**
         * Fungsi inti untuk merender halaman PDF.
         */
        function renderPage(num) {
            pageRendering = true;
            pdfDoc.getPage(num).then(function(page) {
                // Hitung skala berdasarkan lebar container
                const viewport = page.getViewport({ scale: 1 });
                const desiredWidth = canvas.clientWidth;
                const scale = desiredWidth / viewport.width;
                const scaledViewport = page.getViewport({ scale: scale });

                canvas.height = scaledViewport.height;
                canvas.width = desiredWidth;

                const renderContext = {
                    canvasContext: ctx,
                    viewport: scaledViewport
                };
                
                const renderTask = page.render(renderContext);

                renderTask.promise.then(function() {
                    pageRendering = false;
                    if (pageNumPending !== null) {
                        // Render halaman berikutnya yang sedang menunggu
                        renderPage(pageNumPending);
                        pageNumPending = null;
                    }
                    // Simpan progress baca ke Firebase setelah render berhasil
                    saveReadProgress(); 
                });
            });

            // Update UI setelah meminta render
            pageNumInput.value = num;
            document.getElementById('btn-prev-page').disabled = num <= 1;
            document.getElementById('btn-next-page').disabled = num >= pdfDoc.numPages;
        }

        /**
         * Wrapper untuk memuat halaman, menangani antrian render.
         */
        function queueRenderPage(num) {
            if (pageRendering) {
                pageNumPending = num;
            } else {
                renderPage(num);
            }
        }
        
        /**
         * Memuat dokumen PDF dan inisialisasi tampilan.
         */
        async function loadPdf(fileUrl) {
            try {
                const loadingTask = pdfjsLib.getDocument(fileUrl);
                pdfDoc = await loadingTask.promise;
                const totalPages = pdfDoc.numPages;
                pageCountInfo.textContent = `/ ${totalPages}`;
                pageNumInput.setAttribute('max', totalPages);
                
                // Cek progress terakhir
                pageNum = await getSavedProgress() || 1; 
                if (pageNum > totalPages) pageNum = 1;

                // Render halaman pertama/terakhir dibaca
                renderPage(pageNum);

            } catch (err) {
                console.error('PDF loading error: ', err);
                document.getElementById('ebook-title').textContent = `Gagal memuat PDF: ${err.message}`;
                canvas.style.display = 'none';
            }
        }

        /**
         * Menyimpan halaman terakhir yang dibaca oleh user (Asumsi user sudah login).
         */
        function saveReadProgress() {
             const user = typeof getLoggedInUser === 'function' ? getLoggedInUser() : null;
             const urlParams = new URLSearchParams(window.location.search);
             const ebookId = urlParams.get('id');

             if (!user || !user.id || !ebookId) return;

             const progressData = {
                 userId: user.id,
                 ebookId: ebookId,
                 lastPage: pageNum,
                 timestamp: new Date().toISOString()
             };
             // Simpan di path ebookHistory/{userId}_{ebookId}
             dbRef.child(`ebookHistory/${user.id}_${ebookId}`).set(progressData)
                 .then(() => console.log('Progress saved:', pageNum))
                 .catch(error => console.error('Failed to save progress:', error));
        }

        /**
         * Mengambil progress terakhir yang dibaca user.
         */
        async function getSavedProgress() {
             const user = typeof getLoggedInUser === 'function' ? getLoggedInUser() : null;
             const urlParams = new URLSearchParams(window.location.search);
             const ebookId = urlParams.get('id');

             if (!user || !user.id || !ebookId) return null;
             
             try {
                 const snapshot = await dbRef.child(`ebookHistory/${user.id}_${ebookId}`).once('value');
                 if (snapshot.exists()) {
                     const data = snapshot.val();
                     return data.lastPage;
                 }
             } catch (error) {
                 console.log("Failed to retrieve progress:", error);
                 return null;
             }
             return null;
        }


        // --- EVENT HANDLERS ---
        
        // Tombol Sebelumnya
        document.getElementById('btn-prev-page').addEventListener('click', function() {
            if (pdfDoc && pageNum <= pdfDoc.numPages && pageNum > 1) {
                pageNum--;
                queueRenderPage(pageNum);
            }
        });

        // Tombol Selanjutnya
        document.getElementById('btn-next-page').addEventListener('click', function() {
            if (pdfDoc && pageNum < pdfDoc.numPages) {
                pageNum++;
                queueRenderPage(pageNum);
            }
        });
        
        // Input Halaman Manual
        pageNumInput.addEventListener('change', function() {
            let desiredPage = parseInt(this.value);
            if (pdfDoc) {
                 if (desiredPage >= 1 && desiredPage <= pdfDoc.numPages) {
                     pageNum = desiredPage;
                     queueRenderPage(pageNum);
                 } else {
                     alert(`Masukkan halaman antara 1 dan ${pdfDoc.numPages}.`);
                     this.value = pageNum; // Kembalikan ke halaman saat ini
                 }
            }
        });
        
        // Responsiveness: Render ulang saat ukuran jendela berubah (Debounced)
        let resizeTimer;
        window.addEventListener('resize', () => {
             clearTimeout(resizeTimer);
             resizeTimer = setTimeout(() => {
                 if (pdfDoc && !pageRendering) {
                     // Render ulang dengan skala baru
                     renderPage(pageNum); 
                 }
             }, 300); // Tunggu 300ms setelah resize selesai
        });

        // --- INISIALISASI ---
        window.renderEbookReader = async function() {
            const ebook = await getEbookDataFromUrl();
            if (ebook && ebook.fileUrl) {
                await loadPdf(ebook.fileUrl);
            }
        };
    </script>
</body>
</html>