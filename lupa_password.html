<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lupa Password | Libra (Library Area)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="css/style.css"> 
    <link rel="stylesheet" href="css/auth.css"> 
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 'primary': '#4f46e5', 'secondary': '#10b981' }
                }
            }
        }

        // Konfigurasi Proyek LIBRA
        const firebaseConfig = {
            apiKey: "AIzaSyCdVYKc6waij3pmxI9dLDSBIgbYiFIRr3A",
            authDomain: "libra-library-area.firebaseapp.com",
            databaseURL: "https://libra-library-area-default-rtdb.asia-southeast1.firebasedatabase.app", 
            projectId: "libra-library-area",
            storageBucket: "libra-library-area.firebasestorage.app",
            messagingSenderId: "455509444693",
            appId: "1:455509444693:web:883766ec8a49032f0b2cdc",
        };
        firebase.initializeApp(firebaseConfig);
        const dbRef = firebase.database().ref(); 
    </script>
    <script src="js/script.js"></script> 
</head>
<body id="lupa-password-page" class="auth-container">
    <div class="auth-card">
        <h2 id="form-title">Lupa Password?</h2>
        
        <form id="step-1-form" onsubmit="submitStep1(event)">
            <p class="text-center text-gray-600 mb-6" id="step-1-message">Masukkan alamat email atau username Anda yang terdaftar.</p>
            
            <div>
                <label for="email_or_username" class="block text-sm font-medium text-gray-700 mb-1">Email / Username</label>
                <input type="text" id="email_or_username" name="email_or_username" placeholder="Masukkan email atau username" required>
            </div>
            
            <button type="submit" class="auth-btn-primary" id="step-1-btn">
                Kirim Kode Verifikasi
            </button>
        </form>

        <form id="step-2-form" onsubmit="submitStep2(event)" style="display: none;">
            <p class="text-center text-gray-600 mb-6" id="step-2-message">Masukkan **kode 6 digit** yang kami kirimkan ke email Anda dan buat password baru.</p>
            
            <div class="mb-4">
                <label for="verification_code" class="block text-sm font-medium text-gray-700 mb-1">Kode Verifikasi (6 Digit)</label>
                <input type="text" id="verification_code" name="verification_code" placeholder="Misalnya: 123456" maxlength="6" pattern="\d{6}" required>
            </div>
            
            <div class="mb-4">
                <label for="new_password" class="block text-sm font-medium text-gray-700 mb-1">Password Baru</label>
                <input type="password" id="new_password" name="new_password" placeholder="Minimal 6 karakter" minlength="6" required>
            </div>
            
            <div class="mb-4">
                <label for="confirm_password" class="block text-sm font-medium text-gray-700 mb-1">Konfirmasi Password Baru</label>
                <input type="password" id="confirm_password" name="confirm_password" placeholder="Ulangi password baru" required>
            </div>
            
            <button type="submit" class="auth-btn-primary" id="step-2-btn">
                <i class="fas fa-redo mr-2"></i> Reset Password
            </button>
            <button type="button" class="auth-btn-secondary mt-3" onclick="showStep(1)">
                <i class="fas fa-arrow-left mr-2"></i> Kembali ke Email
            </button>
        </form>
        
        <div class="auth-link-text mt-5">
            <a href="login.html">&larr; Kembali ke Login</a>
        </div>
        
    </div>

    <script>
        // Variabel global untuk menyimpan status reset
        let currentUserId = null;
        let generatedCode = null;
        let currentEmail = null; // Untuk pesan notifikasi

        // Fungsi utilitas untuk menampilkan langkah
        function showStep(step) {
            document.getElementById('step-1-form').style.display = step === 1 ? 'block' : 'none';
            document.getElementById('step-2-form').style.display = step === 2 ? 'block' : 'none';
            document.getElementById('form-title').textContent = step === 1 ? 'Lupa Password?' : 'Verifikasi & Password Baru';
        }

        // ===========================================
        // === FUNGSI UTILITY DATABASE (simulasi) ====
        // ===========================================
        
        // Asumsi: Fungsi getAllData() sudah ada di script.js
        // Jika tidak ada, Anda perlu mendefinisikannya agar mengambil data dari Firebase

        /**
         * Mencari user berdasarkan email atau username.
         * @param {string} input Email atau Username
         * @returns {Object|null} Objek user atau null
         */
        async function findUserByEmailOrUsername(input) {
            try {
                // Asumsi: getAllData ada di script.js dan mengembalikan { users: [...] }
                const data = typeof getAllData === 'function' ? await getAllData() : {};
                const users = data.users || [];
                
                const normalizedInput = input.toLowerCase().trim();
                
                const user = users.find(u => 
                    u.email.toLowerCase() === normalizedInput || 
                    (u.username && u.username.toLowerCase() === normalizedInput)
                );
                
                return user || null;
            } catch (error) {
                console.error("Error finding user:", error);
                return null;
            }
        }
        
        /**
         * Mengupdate password user di Firebase Realtime Database.
         * @param {string} userId ID unik user (misalnya, key di Firebase)
         * @param {string} newPassword Password baru
         * @returns {Promise<void>}
         */
        async function updateUserPassword(userId, newPassword) {
            // Catatan: Dalam aplikasi nyata, password HARUS di-hash/enkripsi (misalnya dengan bcrypt) sebelum disimpan.
            // Karena ini adalah Realtime Database dan tidak ada fungsi hash/auth bawaan, kita simpan plain text sebagai simulasi.
            try {
                await dbRef.child('users').child(userId).update({
                    password: newPassword
                });
            } catch (error) {
                console.error("Error updating password:", error);
                throw new Error("Gagal memperbarui password di database.");
            }
        }


        // ===========================================
        // === LOGIKA STEP 1: VERIFIKASI EMAIL/USER ==
        // ===========================================

        /**
         * Mengirimkan kode 6 digit (disimulasikan dengan alert)
         * @param {Object} user Objek user yang ditemukan
         */
        function sendCode(user) {
            const code = Math.floor(100000 + Math.random() * 900000).toString();
            generatedCode = code; // Simpan di variabel global
            currentUserId = user.id;
            currentEmail = user.email; // Simpan email untuk pesan

            // TAMPILKAN KODE (SIMULASI PENGIRIMAN EMAIL)
            alert(`[SIMULASI] Kode verifikasi 6 digit untuk ${user.email} adalah: ${code}\n\nMasukkan kode ini di langkah selanjutnya.`);
            
            // Perbarui pesan di Step 2
            document.getElementById('step-2-message').innerHTML = `Masukkan **kode 6 digit** yang telah dikirimkan ke email **${user.email}** dan buat password baru.`;
            
            showStep(2);
        }

        /**
         * Handler untuk submit Step 1 (Verifikasi Email/Username)
         */
        async function submitStep1(e) {
            e.preventDefault();
            const inputField = document.getElementById('email_or_username');
            const emailOrUsername = inputField.value;
            const btn = document.getElementById('step-1-btn');
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Mencari Akun...';

            const user = await findUserByEmailOrUsername(emailOrUsername);

            btn.disabled = false;
            btn.innerHTML = 'Kirim Kode Verifikasi';

            if (user) {
                sendCode(user);
                inputField.value = ''; // Kosongkan input
            } else {
                alert('Akun dengan email atau username tersebut tidak ditemukan. Silakan coba lagi.');
            }
        }


        // ===========================================
        // === LOGIKA STEP 2: RESET PASSWORD =========
        // ===========================================

        /**
         * Handler untuk submit Step 2 (Verifikasi Kode dan Password Baru)
         */
        async function submitStep2(e) {
            e.preventDefault();
            const codeInput = document.getElementById('verification_code');
            const newPasswordInput = document.getElementById('new_password');
            const confirmPasswordInput = document.getElementById('confirm_password');
            const btn = document.getElementById('step-2-btn');

            const enteredCode = codeInput.value;
            const newPassword = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;

            // 1. Validasi Kode
            if (enteredCode !== generatedCode || !currentUserId) {
                alert('Kode verifikasi salah atau sesi telah kedaluwarsa. Silakan kembali ke langkah 1.');
                return;
            }

            // 2. Validasi Password
            if (newPassword.length < 6) {
                alert('Password baru harus minimal 6 karakter.');
                return;
            }
            if (newPassword !== confirmPassword) {
                alert('Password baru dan konfirmasi password tidak cocok.');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-redo fa-spin mr-2"></i> Memperbarui Password...';

            try {
                // 3. Update Password
                await updateUserPassword(currentUserId, newPassword);

                alert('Password Anda berhasil diperbarui! Silakan login dengan password baru Anda.');
                
                // Reset state dan redirect
                currentUserId = null;
                generatedCode = null;
                currentEmail = null;
                window.location.href = 'login.html';

            } catch (error) {
                alert(`Gagal mereset password: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-redo mr-2"></i> Reset Password';
            }
        }


        document.addEventListener('DOMContentLoaded', () => {
            // Pastikan Step 1 yang pertama kali terlihat saat halaman dimuat
            showStep(1); 
        });
    </script>
</body>
</html>