<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beranda | Libra (Library Area)</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/profil.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        .book-carousel {
            position: relative;
            overflow: hidden;
            border-radius: 12px;
            background-color: #ffffff;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            min-height: 220px; /* Tinggi minimum untuk loading state */
        }
        .carousel-inner {
            display: flex;
            transition: transform 0.5s ease-in-out;
            height: 100%;
        }
   /* Menggunakan <a> sebagai item carousel agar seluruh area bisa diklik */
    .carousel-item-link {
            min-width: 100%;
            display: flex;
            /* align-items: center; <-- HILANGKAN INI */
            align-items: flex-start; /* Mengatur alignment ke ATAS (rata atas) */
            justify-content: flex-start;
            padding: 15px;
            background-color: #f7f9fc;
            text-decoration: none;
            color: inherit;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .carousel-item-link:hover {
            background-color: #eef1f6; /* Sedikit lebih gelap saat hover */
        }
        .carousel-cover-container {
            padding-left: 12px;
            flex-shrink: 0;
            width: 180px; /* Ukuran cover konsisten desktop */
            height: 240px; /* Tinggi cover konsisten desktop */
            margin-right: 20px;
        }
        .carousel-cover-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .carousel-text {
            flex: 1;
            padding-right: 15px; /* Sedikit padding kanan */
        }
        .carousel-text h3 {
            color: #4f46e5; /* Primary Indigo */
        }
        /* Kontrol Navigasi (Tombol) */
        .carousel-control {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            padding: 15px 10px;
            cursor: pointer;
            z-index: 10;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        .carousel-control:hover {
            opacity: 1;
        }
        #prev-btn { left: 0; border-radius: 0 8px 8px 0; }
        #next-btn { right: 0; border-radius: 8px 0 0 8px; }
        /* Indikator Bawah */
        .carousel-indicators {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
        }
        .indicator {
            width: 10px;
            height: 10px;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .indicator.active {
            background-color: #4f46e5; /* Warna Primary */
        }
            /* Media Query untuk Perangkat Mobile (HP) */
            @media (max-width: 700px) {
            .carousel-cover-container {
                width: 150px; /* Ukuran cover konsisten HP */
                height: 180px; /* Tinggi cover konsisten HP */
                margin-top: 0px;
                margin-right: 10;
            }
            .carousel-text {
                margin-left: 0;
                max-width: 100%;
                margin-top: 0px;
            }
            .carousel-text h3 {
                font-size: 1rem;
                margin-bottom: 0px;
            }
            .carousel-text p {
                font-size: 0.7rem;
            }
        }
        @media (max-width: 500px) {
            .book-carousel {
            position: relative;
            overflow: hidden;
            border-radius: 8px;
            background-color: #ffffff;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            min-height: 170px; /* Tinggi minimum untuk loading state */
        }
            .carousel-cover-container {
                width: 90px; /* Ukuran cover konsisten HP */
                height: 120px; /* Tinggi cover konsisten HP */
                margin-top: 0px;
                margin-right: 10;
            }
            .carousel-text {
                margin-left: 0;
                max-width: 100%;
                margin-top: 0px;
            }
            .carousel-text h3 {
                color: #4f46e5; /* Primary Indigo */
                margin-top: 0;
                margin-bottom: 5px; /* Jarak antara Judul dan Penulis/Sinopsis */
                line-height: 0.9; /* KUNCI: Persempit spasi antar baris Judul */
                font-size: 0.9rem; /* Disesuaikan untuk tampilan desktop */
            }
            .carousel-text p {
                font-size: 0.6rem;
                line-height: 0.9; 
            }
        }

        

    </style>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
    </script>
    <script>
        // Konfigurasi Proyek LIBRA Library Area Anda
        const firebaseConfig = {
            apiKey: "AIzaSyCdVYKc6waij3pmxI9dLDSBIgbYiFIRr3A",
            authDomain: "libra-library-area.firebaseapp.com",
            databaseURL: "https://libra-library-area-default-rtdb.asia-southeast1.firebasedatabase.app", 
            projectId: "libra-library-area",
            storageBucket: "libra-library-area.firebasestorage.app",
            messagingSenderId: "455509444693",
            appId: "1:455509444693:web:883766ec8a49032f0b2cdc",
        };
        
        // Inisialisasi Firebase
        firebase.initializeApp(firebaseConfig);
        
        // Referensi ke root database. Variabel ini digunakan di js/script.js
        const dbRef = firebase.database().ref(); 
        const booksRef = dbRef.child('books'); 
        
        console.log("Firebase Realtime Database berhasil diinisialisasi.");
    </script>
    <script src="js/profil.js"></script>
    <script src="js/script.js"></script> 
</head>
<body id="home-page">
    <header class="header">
        <div id="hamburger-menu" class="hamburger order-1"><i class="fas fa-bars"></i></div>
        
        <div class="logo order-2"><a href="index.html">Libra</a></div>
        
        <div class="header-right-menu order-3">
            <div id="profile-icon" class="profile-icon">
                <img id="header-profile-img" src="img/default_user.png" alt="Profil">
                <i class="fas fa-user-circle default-icon"></i> 
            </div>
        </div>

        <nav class="nav-menu">
            <a href="index.html" class="active">Beranda</a>
            <a href="pinjam.html">Pinjam Buku</a>
            <a href="ebook.html">Ebook</a>
            <a href="bookmark.html">BOOKMARK</a>
            <a href="saran.html">Saran & Kritik</a>
        </nav>
    </header>
    <main class="container max-w-6xl mx-auto px-4 py-8">
        
        <section class="book-carousel mb-8" id="book-carousel-container">
            <div id="carousel-inner" class="carousel-inner">
                <div class="carousel-item-link flex justify-center items-center h-full">
                    <i class="fas fa-spinner fa-spin text-4xl text-primary"></i>
                    <p class="ml-4 text-gray-600">Memuat rekomendasi...</p>
                </div>
            </div>
            
            <button id="prev-btn" class="carousel-control hidden" aria-label="Previous"><i class="fas fa-chevron-left"></i></button>
            <button id="next-btn" class="carousel-control hidden" aria-label="Next"><i class="fas fa-chevron-right"></i></button>
            
            <div id="carousel-indicators" class="carousel-indicators">
                </div>
        </section>
        
        <section class="search-section flex flex-col space-y-4 p-4 bg-white shadow-xl rounded-xl">
            <div class="flex flex-col sm:flex-row items-stretch sm:items-center space-y-2 sm:space-y-0 sm:space-x-2">
                <input type="text" id="search-input" placeholder="Cari buku berdasarkan..." class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary text-gray-800 w-full">
                <div class="relative w-full sm:w-auto">
                    <button id="filter-button" class="w-full sm:w-40 flex items-center justify-center px-4 py-3 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 ease-in-out font-semibold text-sm">
                        <i class="fas fa-filter mr-2"></i>
                        <span id="current-filter-text">Semua</span>
                        <i class="fas fa-chevron-down ml-2 text-xs"></i>
                    </button>
        
                    <div id="filter-dropdown" class="absolute left-0 mt-1 w-full sm:w-48 bg-white rounded-lg shadow-2xl border border-gray-100 z-50 opacity-0 invisible transition-opacity duration-300 transform scale-95 origin-top-left" style="min-width: 12rem;">
                        <a href="#" data-filter="all" class="filter-option block px-4 py-2 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 rounded-lg">Semua</a>
                        <a href="#" data-filter="jenis_buku" class="filter-option block px-4 py-2 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 rounded-lg">Jenis Buku</a>
                        <a href="#" data-filter="kategori" class="filter-option block px-4 py-2 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 rounded-lg">Kategori</a>
                        <a href="#" data-filter="genre" class="filter-option block px-4 py-2 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 rounded-lg">Genre</a>
                        </div>
                </div>
                <button id="search-button" class="px-4 py-3 bg-secondary text-white rounded-lg shadow-md hover:bg-green-600 transition duration-150 ease-in-out font-semibold w-full sm:w-auto">
                    <i class="fas fa-search"></i>
                    <span class="ml-1">Cari</span>
                </button>
            </div>
            
            <div id="dynamic-tags" class="flex flex-wrap gap-2 pt-2 min-h-[30px]">
                </div>
        </section>

        <h2 class="text-3xl font-bold text-gray-800 mt-10 mb-6">Daftar Buku</h2>
        <section class="book-list" id="book-list-container">
            <p style="text-align: center;">Memuat daftar...</p>
        </section>
    </main>
    <div id="profile-sidebar" class="sidebar">
        <div class="sidebar-header">
            <button id="close-sidebar" class="close-btn">&times;</button>
        </div>
        <div class="profile-info text-center p-4">
            <img id="sidebar-profile-img" src="img/default_user.png" alt="Foto Profil" class="w-24 h-24 rounded-full mx-auto border-4 border-white shadow-lg">
            <h3 id="sidebar-username" class="mt-3 text-xl font-semibold">Pengunjung</h3>
        </div>
        
        <nav class="sidebar-nav pt-4">
            <a href="#" class="sidebar-link login-feature" id="link-edit-profile-photo">
                <i class="fas fa-camera mr-3"></i> Edit Foto Profil
            </a>
            
            <a href="reset_password.html" class="sidebar-link login-feature" id="link-reset-password">
                <i class="fas fa-key mr-3"></i> Reset Password
            </a>
            
            <hr class="my-4 border-gray-200 login-feature">
            
            <a href="login.html" class="sidebar-link logout-link" id="sidebar-auth-link">
                <i class="fas fa-sign-in-alt mr-3" id="auth-icon"></i> <span id="auth-text">Login/Daftar</span>
            </a>
        </nav>
    </div>
    <div id="sidebar-overlay" class="sidebar-overlay"></div>

    <div id="edit-photo-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-[1000]">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm mx-4">
            <h3 class="text-xl font-bold mb-4">Ubah Foto Profil</h3>
            <form id="edit-photo-form">
                <input type="file" id="modal-foto-upload" accept="image/*" required class="w-full mb-4 p-2 border rounded">
                <div class="flex justify-end space-x-3">
                    <button type="button" id="close-modal" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Batal</button>
                    <button type="submit" class="px-4 py-2 bg-primary text-white rounded hover:bg-indigo-700">Simpan Foto</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ==============================================
        // LOGIKA JAVASCRIPT CAROUSEL (Disesuaikan)
        // ==============================================
        let currentCarouselIndex = 0;
        let booksData = [];

        /**
         * Mengambil data buku dari Firebase dan memilih maksimal 7 buku secara acak.
         * @returns {Promise<Array>} Array buku yang dipilih secara acak.
         */
        async function fetchRandomBooks() {
            try {
                // booksRef didefinisikan di dalam tag <script> di <head>
                const snapshot = await booksRef.once('value'); 
                const allBooks = [];
                
                snapshot.forEach(childSnapshot => {
                    const book = childSnapshot.val();
                    // Hanya tampilkan buku yang memiliki data esensial
                    if (book && book.cover && book.title && book.synopsis) {
                        book.id = childSnapshot.key;
                        allBooks.push(book);
                    }
                });

                if (allBooks.length === 0) {
                    return [];
                }

                // Shuffle array buku (Fisher-Yates)
                for (let i = allBooks.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [allBooks[i], allBooks[j]] = [allBooks[j], allBooks[i]];
                }

                // Ambil maksimal 7 buku teratas
                return allBooks.slice(0, 7);

            } catch (error) {
                console.error("Error fetching books for carousel:", error);
                return [];
            }
        }

        /**
         * Merender item carousel berdasarkan data buku.
         * @param {Array} books Array buku untuk ditampilkan.
         */
        function renderCarousel(books) {
            const carouselInner = document.getElementById('carousel-inner');
            const indicatorsContainer = document.getElementById('carousel-indicators');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');

            carouselInner.innerHTML = '';
            indicatorsContainer.innerHTML = '';
            booksData = books;

            if (books.length === 0) {
                carouselInner.innerHTML = `
                    <div class="carousel-item-link flex justify-center items-center h-80">
                        <p class="text-xl text-gray-500">Tidak ada buku rekomendasi saat ini.</p>
                    </div>`;
                prevBtn.classList.add('hidden');
                nextBtn.classList.add('hidden');
                return;
            }

            books.forEach((book, index) => {
                // Batas sinopsis
                const synopsisText = book.synopsis && book.synopsis.length > 200 
                    ? book.synopsis.substring(0,200) + '...' 
                    : book.synopsis || "Sinopsis tidak tersedia.";

                // Menggunakan elemen <a> agar seluruh area item dapat diklik
                const itemLink = document.createElement('a');
                itemLink.className = 'carousel-item-link';
                // Arahkan ke buka_buku.html dengan ID buku
                itemLink.href = `buka_buku.html?id=${book.id}`; 
                itemLink.dataset.index = index;

                itemLink.innerHTML = `
                    <div class="carousel-cover-container">
                        <img src="${book.cover}" alt="Cover ${book.title}">
                    </div>
                    
                    <div class="carousel-text">
                        <h3 class="text-2xl sm:text-3xl font-bold mb-2">${book.title}</h3>
                        <p class="text-sm font-semibold text-gray-600 mb-1">Oleh: ${book.author || 'Tidak Diketahui'}</p>
                        <p class="text-gray-700 text-sm italic mt-2">${synopsisText}</p>
                    </div><br>
                `;
                carouselInner.appendChild(itemLink);

                // Buat indikator
                const indicator = document.createElement('span');
                indicator.className = 'indicator';
                indicator.dataset.index = index;
                indicator.addEventListener('click', (e) => {
                    e.preventDefault(); // Mencegah klik dari <a> saat mengklik indikator
                    goToSlide(index);
                });
                indicatorsContainer.appendChild(indicator);
            });

            // Tampilkan navigasi jika ada lebih dari 1 buku
            if (books.length > 1) {
                prevBtn.classList.remove('hidden');
                nextBtn.classList.remove('hidden');
            } else {
                prevBtn.classList.add('hidden');
                nextBtn.classList.add('hidden');
            }

            goToSlide(0); // Tampilkan item pertama
        }


        function goToSlide(index) {
            if (booksData.length === 0) return;

            currentCarouselIndex = (index + booksData.length) % booksData.length;
            const offset = -currentCarouselIndex * 100;
            document.getElementById('carousel-inner').style.transform = `translateX(${offset}%)`;

            // Update indikator
            document.querySelectorAll('#carousel-indicators .indicator').forEach((ind, idx) => {
                if (idx === currentCarouselIndex) {
                    ind.classList.add('active');
                } else {
                    ind.classList.remove('active');
                }
            });
        }

        /**
         * Pindah ke slide berikutnya.
         */
        function nextSlide() {
            goToSlide(currentCarouselIndex + 1);
        }

        /**
         * Pindah ke slide sebelumnya.
         */
        function prevSlide() {
            goToSlide(currentCarouselIndex - 1);
        }

        /**
         * Fungsi inisialisasi utama carousel.
         */
        async function initBookCarousel() {
            const randomBooks = await fetchRandomBooks();
            renderCarousel(randomBooks);

            // Pasang event listener untuk tombol
            document.getElementById('prev-btn').addEventListener('click', (e) => {
                e.preventDefault(); // Mencegah perilaku default tombol
                prevSlide();
            });
            document.getElementById('next-btn').addEventListener('click', (e) => {
                e.preventDefault(); // Mencegah perilaku default tombol
                nextSlide();
            });

            // Auto-play (Ganti slide setiap 7 detik jika ada lebih dari 1 buku)
            if (randomBooks.length > 1) {
                setInterval(nextSlide, 7000); 
            }
        }
        
        // ==============================================
        // LOGIKA JAVASCRIPT ASLI (Filter & Search)
        // ==============================================

        // Variabel GLOBAL untuk melacak state filter, diakses oleh js/script.js
        let currentFilterType = 'all'; 
        let activeTag = null; 

        const tagData = {
            'jenis_buku': [
                { name: 'Ebook', value: 'ebook' }, 
                { name: 'Buku Fisik', value: 'fisik' }
            ],
            'kategori': [
                { name: 'Fiksi', value: 'fiksi' }, 
                { name: 'Non Fiksi', value: 'non_fiksi' }
            ],
            'genre': [
                { name: 'Romantis', value: 'romantis' }, 
                { name: 'Fantasi', value: 'fantasi' },
                { name: 'Fiksi Ilmiah', value: 'fiksi ilmiah' },
                { name: 'Horor', value: 'horor' },
                { name: 'Misteri', value: 'misteri' },
                { name: 'Thriller', value: 'thriller' },
                { name: 'Komedi', value: 'komedi' },
                { name: 'Komputer', value: 'komputer' },
                { name: 'Sains', value: 'sains' },
                { name: 'Kuliner', value: 'kuliner' },
                { name: 'Drama', value: 'drama' },
                { name: 'Aksi', value: 'aksi' },
                { name: 'Petualangan', value: 'petualangan' },
            ]
        };

        document.addEventListener('DOMContentLoaded', () => {
            const filterButton = document.getElementById('filter-button');
            const filterDropdown = document.getElementById('filter-dropdown');
            const currentFilterText = document.getElementById('current-filter-text');
            const filterOptions = document.querySelectorAll('.filter-option');
            const dynamicTagsContainer = document.getElementById('dynamic-tags');
            
            initBookCarousel(); 

            const renderTags = (filterType) => {
                dynamicTagsContainer.innerHTML = ''; 
                if (filterType === 'all') {
                    return; 
                }

                const tags = tagData[filterType] || [];
                
                tags.forEach(tag => {
                    const tagElement = document.createElement('span');
                    tagElement.className = `tag-item px-3 py-1 text-sm font-medium rounded-full cursor-pointer transition duration-150 ease-in-out border border-indigo-200 text-indigo-700 bg-indigo-100 hover:bg-indigo-200 whitespace-nowrap`;
                    tagElement.textContent = tag.name;
                    tagElement.dataset.value = tag.value;
                    tagElement.dataset.type = filterType;

                    if (activeTag === tag.value) {
                           tagElement.classList.add('bg-indigo-600', 'text-white', 'border-indigo-600', 'hover:bg-indigo-700');
                           tagElement.classList.remove('bg-indigo-100', 'text-indigo-700', 'hover:bg-indigo-200');
                    }
                    
                    tagElement.addEventListener('click', () => {
                        handleTagClick(tag.value, filterType);
                    });

                    dynamicTagsContainer.appendChild(tagElement);
                });
            };

            const handleTagClick = (tagValue, filterType) => {
                if (activeTag === tagValue) {
                    activeTag = null; 
                } else {
                    activeTag = tagValue; 
                }
                
                renderTags(currentFilterType);

                if (typeof filterBookList === 'function') {
                    filterBookList(currentFilterType, activeTag);
                }
            };

            filterButton.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation(); 
                
                if (filterDropdown.classList.contains('opacity-0')) {
                    filterDropdown.classList.remove('opacity-0', 'invisible', 'scale-95');
                    filterDropdown.classList.add('opacity-100', 'scale-100');
                } else {
                    filterDropdown.classList.remove('opacity-100', 'scale-100');
                    filterDropdown.classList.add('opacity-0', 'invisible', 'scale-95');
                }
            });

            document.addEventListener('click', (e) => {
                if (!filterDropdown.contains(e.target) && !filterButton.contains(e.target)) {
                    filterDropdown.classList.remove('opacity-100', 'scale-100');
                    filterDropdown.classList.add('opacity-0', 'invisible', 'scale-95');
                }
            });

            filterOptions.forEach(option => {
                option.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    const selectedText = option.textContent.trim();
                    const selectedFilter = option.getAttribute('data-filter');
                    
                    currentFilterType = selectedFilter;
                    activeTag = null; 

                    currentFilterText.textContent = selectedText;
                    
                    filterDropdown.classList.remove('opacity-100', 'scale-100');
                    filterDropdown.classList.add('opacity-0', 'invisible', 'scale-95');

                    renderTags(currentFilterType);
                    
                    if (typeof filterBookList === 'function') {
                        filterBookList(currentFilterType, activeTag);
                    }
                });
            });

            if (typeof handleSearch === 'function') {
                handleSearch(document.body.id);
            }
        });
    </script>
</body>
</html>